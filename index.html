<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DINO EMPIRE: HARDCORE EDITION</title>

    <style>
        :root {
            --comum: #95a5a6;
            --incomum: #27ae60;
            --raro: #2980b9;
            --super: #8e44ad;
            --lendario: #f39c12;
            --hibrido: #e74c3c;
            --ceno: #00cec9;
            --n: #00d4ff;
            --bg: #0b0f19;
        }

        * {
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            user-select: none;
            outline: none;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            margin: 0;
            background: var(--bg);
            color: #ecf0f1;
            height: 100vh;
            overflow: hidden;
            touch-action: none;
            font-size: 12px;
        }

        h1, h2, .v, .btn {
            font-family: 'Arial Black', sans-serif;
            letter-spacing: -0.5px;
        }

        #hud {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            background: rgba(11, 15, 25, 0.95);
            padding: 10px;
            position: fixed;
            width: 100%;
            top: 0;
            z-index: 1000;
            border-bottom: 2px solid #333;
            box-shadow: 0 5px 20px rgba(0,0,0,0.8);
        }

        .v {
            font-size: 12px;
            color: #fff;
            display: block;
            margin-top: 2px;
        }

        .l {
            font-size: 9px;
            color: #7f8c8d;
            font-weight: bold;
            display: block;
        }

        #btn-map-toggle {
            cursor: pointer;
            text-align: center;
            border-radius: 4px;
            background: rgba(255,255,255,0.05);
            padding: 2px;
        }

        #viewport {
            width: 100vw;
            height: 100vh;
            position: relative;
            overflow: hidden;
        }

        #map {
            position: absolute;
            width: 6000px;
            height: 6000px;
            transform-origin: 0 0;
            will-change: transform;
        }

        .map-normal {
            background-color: #1a1a1a;
            background-image: radial-gradient(#333 1px, transparent 1px);
            background-size: 40px 40px;
        }

        .map-ceno {
            background-color: #182C36;
            background-image: radial-gradient(#607D8B 1px, transparent 1px);
            background-size: 40px 40px;
        }

        .entity {
            position: absolute;
            transform: translate(-50%, -50%);
            z-index: 10;
            cursor: pointer;
        }

        .entity:active {
            transform: translate(-50%, -50%) scale(0.95);
        }

        .cage {
            width: 80px;
            height: 80px;
            border: 2px solid #555;
            border-radius: 12px;
            background: rgba(0,0,0,0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            backdrop-filter: blur(4px);
            transition: border-color 0.3s;
        }

        .income-tag {
            position: absolute;
            bottom: -18px;
            background: #000;
            color: #2ecc71;
            padding: 2px 4px;
            border-radius: 3px;
            font-size: 8px;
            font-weight: bold;
            border: 1px solid #333;
            white-space: nowrap;
        }

        .lvl-badge {
            position: absolute;
            top: -8px;
            background: #fff;
            color: #000;
            padding: 1px 6px;
            border-radius: 8px;
            font-size: 7px;
            font-weight: 900;
            border: 1px solid #000;
        }

        .dino-emoji {
            font-size: 35px;
            filter: drop-shadow(0 4px 2px rgba(0,0,0,0.5));
        }

        .placement-guide {
            position: absolute;
            width: 100px;
            height: 100px;
            border: 2px dashed #fff;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255,255,255,0.1);
            pointer-events: none;
            z-index: 5;
        }

        .modal {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.9);
            padding: 20px;
            display: none;
            z-index: 5000;
            overflow-y: auto;
        }

        .m-card {
            background: #2c3e50;
            border: 1px solid #444;
            border-radius: 12px;
            padding: 15px;
            max-width: 500px;
            margin: auto;
            box-shadow: 0 0 40px rgba(0,0,0,0.8);
            color: #ecf0f1;
        }

        .m-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            padding-bottom: 10px;
        }

        h2 {
            margin: 0;
            font-size: 16px;
            color: var(--n);
        }

        .btn {
            background: #34495e;
            color: #fff;
            border: none;
            padding: 12px;
            border-radius: 6px;
            width: 100%;
            margin: 5px 0;
            font-weight: bold;
            cursor: pointer;
            text-transform: uppercase;
            font-size: 10px;
            transition: 0.2s;
            box-shadow: 0 3px 0 rgba(0,0,0,0.3);
        }

        .btn:active {
            transform: translateY(3px);
            box-shadow: none;
        }

        .btn-close {
            background: #c0392b;
            margin-top: 15px;
        }

        #idx-list {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 5px;
            max-height: 50vh;
            overflow-y: auto;
            padding: 5px;
        }

        .idx-card {
            background: rgba(0,0,0,0.3);
            border-radius: 8px;
            padding: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            border: 1px solid #444;
            position: relative;
            min-height: 70px;
            justify-content: center;
        }

        .idx-emoji {
            font-size: 24px;
        }

        .idx-name {
            font-size: 7px;
            text-align: center;
            color: #bdc3c7;
            margin-top: 4px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            width: 100%;
        }

        .idx-locked {
            opacity: 0.3;
            filter: grayscale(1);
        }

        .idx-locked::after {
            content: "üîí";
            position: absolute;
            font-size: 14px;
        }

        .inv-row {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
            align-items: center;
            background: rgba(0,0,0,0.2);
            padding: 5px;
            border-radius: 6px;
            border-left: 3px solid #555;
        }

        .btn-sell-inv {
            background: #c0392b !important;
            width: 60px !important;
        }

        nav {
            position: fixed;
            bottom: 0;
            width: 100%;
            height: 70px;
            background: #151820;
            border-top: 1px solid #333;
            display: flex;
            z-index: 1000;
            padding-bottom: 10px;
        }

        .nav-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 8px;
            color: #7f8c8d;
            cursor: pointer;
        }

        .nav-item span {
            font-size: 20px;
            margin-bottom: 4px;
        }

        .nav-item:active {
            background: #222;
            color: #fff;
        }

        #panel {
            position: fixed;
            bottom: 80px;
            left: 5%;
            width: 90%;
            background: #2c3e50;
            border: 1px solid #fff;
            border-radius: 12px;
            padding: 15px;
            display: none;
            z-index: 2000;
            box-shadow: 0 0 50px #000;
        }

        #log {
            position: fixed;
            bottom: 90px;
            left: 10px;
            pointer-events: none;
            z-index: 4000;
            width: 80%;
        }

        .log-msg {
            background: rgba(0,0,0,0.8);
            color: #fff;
            padding: 4px 10px;
            border-radius: 4px;
            margin-top: 4px;
            font-size: 10px;
            border-left: 3px solid var(--n);
            animation: fadeOut 3s forwards;
        }

        .rar-comum { border-color: var(--comum); box-shadow: 0 0 5px var(--comum); }
        .rar-incomum { border-color: var(--incomum); box-shadow: 0 0 8px var(--incomum); }
        .rar-raro { border-color: var(--raro); box-shadow: 0 0 10px var(--raro); }
        .rar-super { border-color: var(--super); box-shadow: 0 0 15px var(--super); border-width: 3px; }
        .rar-lendario { border-color: var(--lendario); box-shadow: 0 0 20px var(--lendario); border-width: 3px; animation: shine 2s infinite; }
        .rar-hibrido { border-color: var(--hibrido); box-shadow: 0 0 25px var(--hibrido); }
        .rar-ceno { border-color: var(--ceno); box-shadow: 0 0 10px var(--ceno); }

        #btn-confirm {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            width: 200px;
            display: none;
            z-index: 4000;
            background: #27ae60;
            border: 2px solid #fff;
        }

        @keyframes fadeOut {
            0%, 80% { opacity: 1 }
            100% { opacity: 0; transform: translateY(-10px); }
        }

        @keyframes shine {
            0%, 100% { box-shadow: 0 0 10px var(--lendario); }
            50% { box-shadow: 0 0 25px var(--lendario); }
        }
    </style>
</head>
<body>

<div id="log"></div>

<div id="hud">
    <div>
        <span class="l">DINHEIRO</span>
        <span id="v-cash" class="v" style="color:#f1c40f">$0</span>
    </div>
    <div>
        <span class="l">CARNE</span>
        <span id="v-food" class="v" style="color:#e67e22">0</span>
    </div>
    <div>
        <span class="l">C-DNA</span>
        <span id="v-ceno" class="v" style="color:var(--ceno)">0</span>
    </div>
    <div id="btn-map-toggle" onclick="switchWorld()">
        <span class="l">MAPA</span>
        <span id="v-world" class="v">JUR√ÅSSICO</span>
    </div>
</div>

<div id="viewport">
    <div id="map" class="map-normal">
        <div id="placement-indicator" class="placement-guide" style="display:none"></div>
        <div id="entities-layer"></div>
    </div>
</div>

<button id="btn-confirm" class="btn" onclick="confirmPlacement()">POSICIONAR ‚úÖ</button>

<div id="modal-shop" class="modal">
    <div class="m-card">
        <div class="m-header">
            <h2>MERCADO NEGRO</h2>
            <span onclick="closeModals()">‚úñ</span>
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
            <button class="btn" onclick="buy('herb', 5000)">üåø PACOTE B√ÅSICO<br><small>$5.000</small></button>
            <button class="btn" onclick="buy('carn', 15000)">ü•© PACOTE CA√áADOR<br><small>$15.000</small></button>
            <button class="btn" onclick="buy('fly', 45000)">ü¶Ö PACOTE A√âREO<br><small>$45.000</small></button>
            <button class="btn" onclick="buy('wat', 100000)">ü¶à PACOTE ABISSAL<br><small>$100.000</small></button>
        </div>
        <div style="background: rgba(0,0,0,0.3); padding: 10px; margin-top: 10px; border-radius: 6px; font-size: 9px; color: #aaa;">
            Pacotes mais caros t√™m maior chance de Super Raros e Lend√°rios.
        </div>
        <button class="btn" style="background: var(--ceno); margin-top: 10px; color: #000;" onclick="buy('ceno', 0)">
            üß¨ OVO CENOZ√ìICO (1 C-DNA)
        </button>
    </div>
</div>

<div id="modal-lab" class="modal">
    <div class="m-card">
        <div class="m-header">
            <h2>ENGENHARIA GEN√âTICA</h2>
            <span onclick="closeModals()">‚úñ</span>
        </div>
        <p style="font-size: 10px; color: #aaa; margin-bottom: 10px;">
            Funda dinossauros n√≠vel 30+ para criar h√≠bridos poderosos.
        </p>
        <div style="border: 1px solid var(--hibrido); padding: 10px; border-radius: 8px; margin-bottom: 10px;">
            <b style="color: var(--hibrido);">INDOMINUS REX</b>
            <small style="float: right;">$500.000</small><br>
            <span style="font-size: 9px;">T-Rex n√≠vel 30 + Raptor n√≠vel 30</span>
            <button class="btn" style="margin-top: 5px; background: rgba(231,76,60,0.3);" onclick="fuse('Indominus Rex')">FUNDIR</button>
        </div>
        <div style="border: 1px solid var(--hibrido); padding: 10px; border-radius: 8px;">
            <b style="color: var(--hibrido);">INDORAPTOR</b>
            <small style="float: right;">$2.000.000</small><br>
            <span style="font-size: 9px;">Indominus n√≠vel 30 + Raptor n√≠vel 30</span>
            <button class="btn" style="margin-top: 5px; background: rgba(231,76,60,0.3);" onclick="fuse('Indoraptor')">FUNDIR</button>
        </div>
    </div>
</div>

<div id="modal-exp" class="modal">
    <div class="m-card">
        <div class="m-header">
            <h2>EXPEDI√á√ÉO √ÅRTICA</h2>
            <span onclick="closeModals()">‚úñ</span>
        </div>
        <div style="text-align: center; padding: 20px 0;">
            <div style="font-size: 40px;">üöÅ</div>
            <p>Enviar equipe para recuperar DNA Cenoz√≥ico congelado.</p>
            <p style="color: var(--lendario); font-weight: bold;">$75.000</p>
            <button id="exp-btn" class="btn" style="background: #27ae60;" onclick="startExp(60, 75000)">INICIAR (60s)</button>
        </div>
        <p id="exp-timer" style="text-align: center; font-weight: bold; color: #f39c12;"></p>
    </div>
</div>

<div id="modal-index" class="modal">
    <div class="m-card">
        <div class="m-header">
            <h2>DINOP√âDIA</h2>
            <span onclick="closeModals()">‚úñ</span>
        </div>
        <div id="idx-list"></div>
        <button class="btn btn-close" onclick="closeModals()">FECHAR</button>
    </div>
</div>

<div id="modal-inv" class="modal">
    <div class="m-card">
        <div class="m-header">
            <h2>INVENT√ÅRIO</h2>
            <span onclick="closeModals()">‚úñ</span>
        </div>
        <div id="inv-grid" style="max-height: 300px; overflow-y: auto;"></div>
        <button class="btn btn-close" onclick="closeModals()">FECHAR</button>
    </div>
</div>

<div id="panel">
    <div style="display: flex; justify-content: space-between;">
        <h2 id="p-name" style="color: #fff;"></h2>
        <span id="p-rar" style="font-size: 9px; padding: 3px; border-radius: 4px;"></span>
    </div>
    <div id="p-stats" style="margin: 15px 0; font-size: 11px; color: #bdc3c7; display: grid; grid-template-columns: 1fr 1fr; gap: 10px;"></div>
    <button class="btn" style="background: #e67e22;" onclick="upgradeDino()">ü•© ALIMENTAR ($<span id="p-cost"></span>)</button>
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 5px;">
        <button class="btn" style="background: #2980b9;" onclick="initMove()">MOVER</button>
        <button class="btn" style="background: #c0392b;" onclick="sellDino()">VENDER</button>
    </div>
    <button class="btn btn-close" onclick="closePanel()">FECHAR</button>
</div>

<nav>
    <div class="nav-item" onclick="openModal('shop')"><span>üõí</span>LOJA</div>
    <div class="nav-item" onclick="openModal('lab')"><span>üß¨</span>LAB</div>
    <div class="nav-item" onclick="openModal('exp')"><span>üöÅ</span>EXPED</div>
    <div class="nav-item" onclick="openIndex()"><span>üìñ</span>INDEX</div>
    <div class="nav-item" onclick="openModal('inv')"><span>üì¶</span>INV</div>
    <div class="nav-item" id="btn-food">
        <span>ü•©</span>
        <div id="farm-combo" style="font-size: 9px; font-weight: bold; opacity: 0; margin-top: 1px;">√ó1</div>
        FARM
    </div>
</nav>

<script>
// ============================================================================
// DADOS DO JOGO - DINOS E RARIDADES
// ============================================================================
const DATA = {
    carn: [
        {n: "Compy", e: "ü¶é"},
        {n: "Dilophosaurus", e: "üêç"},
        {n: "Velociraptor", e: "ü¶ñ"},
        {n: "Carnotaurus", e: "üêÇ"},
        {n: "Allosaurus", e: "üêä"},
        {n: "Tyrannosaurus Rex", e: "ü¶ñ"},
        {n: "Spinosaurus", e: "ü¶à"},
        {n: "Giganotosaurus", e: "üê≤"}
    ],
    herb: [
        {n: "Gallimimus", e: "ü¶§"},
        {n: "Pachycephalosaurus", e: "üêê"},
        {n: "Parasaurolophus", e: "üé∑"},
        {n: "Ankylosaurus", e: "üê¢"},
        {n: "Stegosaurus", e: "üõ°Ô∏è"},
        {n: "Triceratops", e: "üöú"},
        {n: "Brachiosaurus", e: "ü¶ï"},
        {n: "Titanosaurus", e: "üèöÔ∏è"}
    ],
    fly: [
        {n: "Dimorphodon", e: "ü¶á"},
        {n: "Pteranodon", e: "ü¶Ö"},
        {n: "Tapejara", e: "ü¶ú"},
        {n: "Quetzalcoatlus", e: "‚úàÔ∏è"}
    ],
    wat: [
        {n: "Ichthyosaurus", e: "üêü"},
        {n: "Plesiosaurus", e: "ü¶ï"},
        {n: "Mosasaurus", e: "ü¶à"},
        {n: "Megalodon", e: "ü¶∑"}
    ],
    ceno: [
        {n: "Dodo", e: "ü¶§"},
        {n: "Smilodon", e: "üêÖ"},
        {n: "Mamute", e: "ü¶£"},
        {n: "Pregui√ßa Gigante", e: "ü¶•"}
    ],
    hibrido: [
        {n: "Indominus Rex", e: "üß¨"},
        {n: "Indoraptor", e: "üåë"}
    ]
};

const RARITY = {
    comum:    { color: "#95a5a6", name: "COMUM",    mult: 1   },
    incomum:  { color: "#27ae60", name: "INCOMUM",  mult: 1.5 },
    raro:     { color: "#2980b9", name: "RARO",     mult: 3   },
    super:    { color: "#8e44ad", name: "SUPER",    mult: 6   },
    lendario: { color: "#f39c12", name: "LEND√ÅRIO", mult: 15  },
    hibrido:  { color: "#e74c3c", name: "H√çBRIDO",  mult: 40  },
    ceno:     { color: "#00cec9", name: "CENOZ√ìICO",mult: 8   }
};

// ============================================================================
// ESTADO DO JOGO
// ============================================================================
let state = {
    cash: 15000,
    food: 1000,
    cenoDNA: 0,
    dinos: [],
    inv: [],
    discovered: [],
    expEnd: 0,
    world: "normal",
    cam: { x: -2900, y: -2900 },
    placing: null,
    selected: null
};

// ============================================================================
// VARI√ÅVEIS DO FARM
// ============================================================================
let farmInterval = null;
let farmStartTime = 0;
let farmMultiplier = 1;

// ============================================================================
// ELEMENTOS DO FARM
// ============================================================================
const btnFood = document.getElementById("btn-food");
const comboEl = document.getElementById("farm-combo");

// ============================================================================
// INICIAR FARM (SEGURAR)
// ============================================================================
function startFarm(e) {
    e.preventDefault();
    e.stopPropagation();

    if (farmInterval) return;

    farmStartTime = Date.now();
    farmMultiplier = 1;
    comboEl.style.opacity = "1";
    comboEl.innerText = "√ó1";
    comboEl.style.color = "#2ecc71";

    farmInterval = setInterval(() => {
        if (state.cash < 20) {
            stopFarm();
            addLog("Sem dinheiro para continuar!");
            return;
        }

        const seconds = (Date.now() - farmStartTime) / 1000;
        farmMultiplier = Math.min(200, 1 + Math.floor(seconds * 19.9));

        const foodPerTick = Math.floor(15 * farmMultiplier);
        state.cash -= 20;
        state.food += foodPerTick;

        comboEl.innerText = `√ó${farmMultiplier}`;
        comboEl.style.color = 
            farmMultiplier >= 150 ? "#c0392b" :
            farmMultiplier >= 100 ? "#e74c3c" :
            farmMultiplier >= 50  ? "#f39c12" :
            farmMultiplier >= 20  ? "#f1c40f" : "#2ecc71";

        updateHUD();
    }, 80);
}

// ============================================================================
// PARAR FARM
// ============================================================================
function stopFarm(e) {
    if (e) {
        e.preventDefault();
        e.stopPropagation();
    }
    if (farmInterval) {
        clearInterval(farmInterval);
        farmInterval = null;
        comboEl.style.opacity = "0";
        farmMultiplier = 1;
    }
}

btnFood.addEventListener("pointerdown", startFarm, { passive: false });
btnFood.addEventListener("pointerup", stopFarm);
btnFood.addEventListener("pointerleave", stopFarm);
btnFood.addEventListener("pointercancel", stopFarm);

btnFood.addEventListener("touchstart", startFarm, { passive: false });
btnFood.addEventListener("touchend", stopFarm);
btnFood.addEventListener("touchcancel", stopFarm);

// ============================================================================
// LOOP PRINCIPAL DO JOGO
// ============================================================================
function tick() {
    let totalIncome = 0;

    state.dinos.forEach(dino => {
        const rarityMult = RARITY[dino.rar]?.mult || 1;
        const level = Number(dino.lvl) || 1;
        const base = dino.cat === "ceno" ? 8 : 2;
        const income = (base * rarityMult * level) * 0.4;
        totalIncome += income;
        dino.lastInc = Math.round(income * 10);
    });

    state.cash += totalIncome;

    if (state.expEnd > Date.now()) {
        const secondsLeft = Math.ceil((state.expEnd - Date.now()) / 1000);
        document.getElementById("exp-timer").innerText = `${secondsLeft}s`;
        document.getElementById("exp-btn").disabled = true;
        document.getElementById("exp-btn").style.opacity = 0.5;
    } else {
        if (state.expEnd !== 0) finishExp();
        document.getElementById("exp-timer").innerText = "";
        document.getElementById("exp-btn").disabled = false;
        document.getElementById("exp-btn").style.opacity = 1;
    }

    updateHUD();
}

// ============================================================================
// ATUALIZA HUD E VALORES NA TELA
// ============================================================================
function updateHUD() {
    document.getElementById("v-cash").innerText = "$" + abb(state.cash);
    document.getElementById("v-food").innerText = abb(state.food);
    document.getElementById("v-ceno").innerText = state.cenoDNA || 0;

    state.dinos.forEach((dino, index) => {
        if (dino.world !== state.world) return;
        const element = document.getElementById(`inc-${index}`);
        if (element) {
            element.innerText = `+\[ {abb(dino.lastInc || 0)}/s`;
        }
    });
}

// ============================================================================
// FORMATA√á√ÉO DE N√öMEROS GRANDES
// ============================================================================
function abb(value) {
    if (typeof value !== "number" || isNaN(value) || value == null) return "0";
    value = Number(value);

    if (value >= 1e12) return (value / 1e12).toFixed(1).replace(/\.0$/, "") + "T";
    if (value >= 1e9)  return (value / 1e9 ).toFixed(1).replace(/\.0$/, "") + "B";
    if (value >= 1e6)  return (value / 1e6 ).toFixed(1).replace(/\.0$/, "") + "M";
    if (value >= 1e3)  return Math.floor(value / 1000) + "K";
    return Math.floor(value);
}

// ============================================================================
// COMPRAR NA LOJA
// ============================================================================
function buy(category, price) {
    if (category === "ceno") {
        if (state.cenoDNA < 1) return alert("Voc√™ precisa de DNA Cenoz√≥ico!");
        state.cenoDNA--;
    } else {
        if (state.cash < price) return alert("Dinheiro insuficiente!");
        state.cash -= price;
    }

    const dino = generateDino(category);
    state.inv.push(dino);
    addLog(`üì¶ Voc√™ ganhou: \( {dino.name} ( \){RARITY[dino.rar]?.name || "???"})`);
    openModal("inv");
    save();
}

// ============================================================================
// GERAR DINO ALEAT√ìRIO (com prote√ß√£o de campos)
// ============================================================================
function generateDino(category) {
    const pool = DATA[category] || DATA.carn;
    const selected = pool[Math.floor(Math.random() * pool.length)];

    let rand = Math.random() * 100;
    let rarity = "comum";

    if (category === "ceno") rarity = "ceno";
    else if (category === "herb") {
        if (rand < 70) rarity = "comum";
        else if (rand < 95) rarity = "incomum";
        else if (rand < 99) rarity = "raro";
        else rarity = "super";
    } else if (category === "carn") {
        if (rand < 50) rarity = "comum";
        else if (rand < 80) rarity = "incomum";
        else if (rand < 95) rarity = "raro";
        else if (rand < 99) rarity = "super";
        else rarity = "lendario";
    } else if (category === "fly") {
        if (rand < 30) rarity = "comum";
        else if (rand < 60) rarity = "incomum";
        else if (rand < 85) rarity = "raro";
        else if (rand < 97) rarity = "super";
        else rarity = "lendario";
    } else if (category === "wat") {
        if (rand < 10) rarity = "comum";
        else if (rand < 30) rarity = "incomum";
        else if (rand < 70) rarity = "raro";
        else if (rand < 90) rarity = "super";
        else rarity = "lendario";
    }

    if (!state.discovered.includes(selected.n)) {
        state.discovered.push(selected.n);
    }

    return {
        name: selected.n || "Dino Desconhecido",
        img: selected.e || "?",
        cat: category,
        rar: rarity,
        lvl: 1,
        x: 0,
        y: 0,
        world: category === "ceno" ? "ceno" : "normal",
        lastInc: 0
    };
}

// ============================================================================
// FUS√ÉO DE DINOS
// ============================================================================
function fuse(type) {
    let reqA = type === "Indominus Rex" ? "T-Rex" : "Indominus Rex";
    let cost = type === "Indominus Rex" ? 500000 : 2000000;

    let idxA = state.dinos.findIndex(d => d.name === reqA && (d.lvl || 0) >= 30);
    let idxB = state.dinos.findIndex((d, i) => d.name === "Raptor" && (d.lvl || 0) >= 30 && i !== idxA);

    if (idxA > -1 && idxB > -1 && state.cash >= cost) {
        state.cash -= cost;

        const toRemove = [idxA, idxB].sort((a, b) => b - a);
        state.dinos.splice(toRemove[0], 1);
        state.dinos.splice(toRemove[1], 1);

        const hybrid = {
            name: type,
            img: type === "Indominus Rex" ? "üß¨" : "üåë",
            cat: "hibrido",
            rar: "hibrido",
            lvl: 1,
            x: 0,
            y: 0,
            world: "normal",
            lastInc: 0
        };

        state.inv.push(hybrid);

        if (!state.discovered.includes(type)) {
            state.discovered.push(type);
        }

        addLog(`üß¨ ${type} criado com sucesso!`);
        closeModals();
        openModal("inv");
        render();
        save();
    } else {
        alert(`Voc√™ precisa de: ${reqA} n√≠vel 30 + Raptor n√≠vel 30 + \]{abb(cost)}`);
    }
}

// ============================================================================
// ABRIR MODAL
// ============================================================================
function openModal(id) {
    document.querySelectorAll(".modal").forEach(m => m.style.display = "none");
    const modal = document.getElementById("modal-" + id);
    if (modal) modal.style.display = "block";

    if (id === "inv") {
        const grid = document.getElementById("inv-grid");
        grid.innerHTML = "";

        if (!state.inv.length) {
            grid.innerHTML = "<p style='text-align:center;color:#777'>Seu invent√°rio est√° vazio</p>";
            return;
        }

        state.inv.forEach((dino, index) => {
            const name = dino.name || "Dino Desconhecido";
            const emoji = dino.img || "?";
            const rarityName = RARITY[dino.rar]?.name || "???";
            const color = RARITY[dino.rar]?.color || "#fff";

            const row = document.createElement("div");
            row.className = "inv-row rar-" + (dino.rar || "comum");

            row.innerHTML = `
                <div style="font-size:20px">${emoji}</div>
                <div style="flex:1">
                    <div style="font-weight:bold; color:\( {color}"> \){name}</div>
                    <div style="font-size:8px; color:#aaa">${rarityName}</div>
                </div>
                <button class="btn" style="width:auto; padding:5px 10px" onclick="startPlace(${index})">SOLTAR</button>
                <button class="btn btn-sell-inv" onclick="sellInv(${index})">\[ {abb(500 * (RARITY[dino.rar]?.mult || 1))}</button>
            `;

            grid.appendChild(row);
        });
    }
}

// ============================================================================
// ABRIR DINOP√âDIA
// ============================================================================
function openIndex() {
    document.querySelectorAll(".modal").forEach(m => m.style.display = "none");
    document.getElementById("modal-index").style.display = "block";

    const list = document.getElementById("idx-list");
    list.innerHTML = "";

    ["carn", "herb", "fly", "wat", "ceno", "hibrido"].forEach(cat => {
        DATA[cat].forEach(dino => {
            const unlocked = state.discovered.includes(dino.n);
            const card = document.createElement("div");
            card.className = unlocked ? "idx-card" : "idx-card idx-locked";
            card.innerHTML = `
                <div class="idx-emoji">${dino.e || "?"}</div>
                <div class="idx-name">${dino.n || "Desconhecido"}</div>
            `;
            list.appendChild(card);
        });
    });
}

// ============================================================================
// VENDER DO INVENT√ÅRIO
// ============================================================================
function sellInv(index) {
    const dino = state.inv[index];
    if (!dino) return;

    const value = 500 * (RARITY[dino.rar]?.mult || 1);
    state.cash += value;
    state.inv.splice(index, 1);
    openModal("inv");
    save();
}

// ============================================================================
// POSICIONAR DINO
// ============================================================================
function startPlace(index) {
    state.placing = state.inv.splice(index, 1)[0];
    state.placing.x = Math.abs(state.cam.x) + (window.innerWidth / 2);
    state.placing.y = Math.abs(state.cam.y) + (window.innerHeight / 2);
    document.getElementById("btn-confirm").style.display = "block";
    closeModals();
    render();
}

function confirmPlacement() {
    if (!state.placing) return;
    state.dinos.push(state.placing);
    state.placing = null;
    document.getElementById("btn-confirm").style.display = "none";
    render();
    save();
}

// ============================================================================
// RENDERIZAR MAPA
// ============================================================================
function render() {
    const layer = document.getElementById("entities-layer");
    layer.innerHTML = "";

    state.dinos.forEach((dino, index) => {
        if (dino.world !== state.world) return;

        const entity = document.createElement("div");
        entity.className = "entity";
        entity.style.left = dino.x + "px";
        entity.style.top = dino.y + "px";
        entity.onclick = () => openPanel(index);

        entity.innerHTML = `
            <div class="cage rar-${dino.rar || "comum"}">
                <div class="lvl-badge">${dino.lvl || 1}</div>
                <div class="dino-emoji">${dino.img || "?"}</div>
                <div class="income-tag" id="inc-${index}">...</div>
            </div>
        `;

        layer.appendChild(entity);
    });

    const indicator = document.getElementById("placement-indicator");
    if (state.placing) {
        indicator.style.display = "block";
        indicator.style.left = state.placing.x + "px";
        indicator.style.top = state.placing.y + "px";
    } else {
        indicator.style.display = "none";
    }
}

// ============================================================================
// PAINEL DO DINO
// ============================================================================
function openPanel(index) {
    state.selected = index;
    const dino = state.dinos[index] || {};
    const rarity = RARITY[dino.rar] || RARITY.comum;

    document.getElementById("panel").style.display = "block";
    document.getElementById("p-name").innerText = dino.name || "Dino Desconhecido";
    document.getElementById("p-rar").innerText = rarity.name;
    document.getElementById("p-rar").style.background = rarity.color;
    document.getElementById("p-rar").style.color = (dino.rar === "comum" || dino.rar === "lendario") ? "#000" : "#fff";

    const upgradeCost = Math.floor(250 * rarity.mult * Math.pow(1.15, dino.lvl || 1));
    document.getElementById("p-cost").innerText = abb(upgradeCost);

    document.getElementById("p-stats").innerHTML = `
        <div>N√≠vel: <b style="color:#fff">${dino.lvl || 1}</b></div>
        <div>Lucro: <b style="color:#2ecc71"> \]{abb(dino.lastInc || 0)}/s</b></div>
    `;
}

// ============================================================================
// MELHORAR DINO
// ============================================================================
function upgradeDino() {
    const dino = state.dinos[state.selected];
    if (!dino) return;

    const rarity = RARITY[dino.rar] || RARITY.comum;
    const cost = Math.floor(250 * rarity.mult * Math.pow(1.15, dino.lvl || 1));

    if (state.food >= cost) {
        state.food -= cost;
        dino.lvl = (dino.lvl || 1) + 1;
        addLog("N√≠vel aumentado! ü•©");
        openPanel(state.selected);
        save();
    } else {
        addLog("Carne insuficiente!");
    }
}

// ============================================================================
// VENDER DINO
// ============================================================================
function sellDino() {
    const dino = state.dinos[state.selected];
    if (!dino) return;

    const value = Math.floor((dino.lvl || 1) * 200 * (RARITY[dino.rar]?.mult || 1));

    if (confirm(`Vender por $${abb(value)}?`)) {
        state.cash += value;
        state.dinos.splice(state.selected, 1);
        closePanel();
        render();
        save();
    }
}

// ============================================================================
// MOVER DINO
// ============================================================================
function initMove() {
    state.placing = state.dinos.splice(state.selected, 1)[0];
    document.getElementById("btn-confirm").style.display = "block";
    closePanel();
    render();
}

// ============================================================================
// DRAG DO MAPA
// ============================================================================
let isDragging = false;
let lastX, lastY;
const mapElement = document.getElementById("map");

window.onpointerdown = e => {
    if (e.target.closest("#btn-food, .modal, nav, #hud, #panel, #btn-confirm")) return;
    isDragging = true;
    lastX = e.pageX;
    lastY = e.pageY;
};

window.onpointermove = e => {
    if (!isDragging) return;
    const dx = e.pageX - lastX;
    const dy = e.pageY - lastY;

    if (state.placing) {
        state.placing.x += dx;
        state.placing.y += dy;
        render();
    } else {
        state.cam.x += dx;
        state.cam.y += dy;
        state.cam.x = Math.max(-5000, Math.min(0, state.cam.x));
        state.cam.y = Math.max(-5000, Math.min(0, state.cam.y));
        mapElement.style.transform = `translate(${state.cam.x}px, ${state.cam.y}px)`;
    }

    lastX = e.pageX;
    lastY = e.pageY;
};

window.onpointerup = () => isDragging = false;

// ============================================================================
// LOGS
// ============================================================================
function addLog(message) {
    const logArea = document.getElementById("log");
    const entry = document.createElement("div");
    entry.className = "log-msg";
    entry.innerText = message;
    logArea.prepend(entry);

    if (logArea.children.length > 5) {
        logArea.lastChild.remove();
    }

    setTimeout(() => entry.remove(), 3500);
}

// ============================================================================
// MUDAR MUNDO
// ============================================================================
function switchWorld() {
    state.world = state.world === "normal" ? "ceno" : "normal";
    document.getElementById("v-world").innerText = state.world === "normal" ? "JUR√ÅSSICO" : "CENOZ√ìICO";
    document.getElementById("map").className = "map-" + state.world;
    render();
    updateHUD();
}

// ============================================================================
// EXPEDI√á√ÉO
// ============================================================================
function startExp(duration, cost) {
    if (state.cash >= cost) {
        state.cash -= cost;
        state.expEnd = Date.now() + (duration * 1000);
        save();
    } else {
        alert("Dinheiro insuficiente!");
    }
}

function finishExp() {
    state.expEnd = 0;
    state.cenoDNA++;
    addLog("Expedi√ß√£o trouxe 1 DNA Cenoz√≥ico!");
    save();
}

// ============================================================================
// FECHAR MODAIS E PAINEL
// ============================================================================
function closeModals() {
    document.querySelectorAll(".modal").forEach(m => {
        m.style.display = "none";
    });
}

function closePanel() {
    document.getElementById("panel").style.display = "none";
    state.selected = null;
}

// ============================================================================
// SAVE E LOAD
// ============================================================================
function save() {
    try {
        localStorage.setItem("DINO_HARD_SAVEv2", JSON.stringify(state));
    } catch (err) {
        console.error("Erro ao salvar:", err);
    }
}

function load() {
    const saved = localStorage.getItem("DINO_HARD_SAVEv2");
    if (saved) {
        try {
            const parsed = JSON.parse(saved);
            state = { ...state, ...parsed };

            // Prote√ß√£o contra corrup√ß√£o
            state.dinos = state.dinos.filter(d => d && d.name);
            state.inv = state.inv.filter(d => d && d.name);

            state.dinos.forEach(d => {
                d.name = d.name || "Dino Desconhecido";
                d.img = d.img || "?";
                d.rar = d.rar || "comum";
                d.lvl = Number(d.lvl) || 1;
                d.lastInc = Number(d.lastInc) || 0;
            });

            state.inv.forEach(d => {
                d.name = d.name || "Dino Desconhecido";
                d.img = d.img || "?";
                d.rar = d.rar || "comum";
            });

            if (typeof state.cash !== "number" || isNaN(state.cash)) state.cash = 15000;
            if (typeof state.food !== "number" || isNaN(state.food)) state.food = 1000;
            if (typeof state.cenoDNA !== "number" || isNaN(state.cenoDNA)) state.cenoDNA = 0;
            if (!state.cam) state.cam = { x: -2900, y: -2900 };
            if (!state.world) state.world = "normal";
        } catch (err) {
            console.error("Save corrompido:", err);
        }
    }
}

// ============================================================================
// INICIALIZA√á√ÉO
// ============================================================================
load();
setInterval(tick, 100);
setInterval(save, 15000);
render();
mapElement.style.transform = `translate(${state.cam.x}px, ${state.cam.y}px)`;
</script>
</body>
</html>
